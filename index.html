<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººæ—…è¡Œåˆ†è´¦ - å®æ—¶ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #f0fdf4; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #059669; color: white; border-radius: 8px; font-weight: 600; }
        .btn-danger { color: #ef4444; font-size: 0.875rem; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 max-w-lg mx-auto pb-20">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold text-green-800">ğŸŒ´ æ—…è¡Œè®°è´¦é€š</h1>
        <button onclick="copyLink()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full flex items-center gap-1">
            <span>ğŸ”— å¤åˆ¶é“¾æ¥é‚€è¯·</span>
        </button>
    </div>

    <div class="text-center text-gray-500 text-xs mb-4">
        å½“å‰æˆ¿é—´ ID: <span id="roomIdDisplay" class="font-mono font-bold text-gray-700">åŠ è½½ä¸­...</span>
    </div>

    <div class="card p-4 mb-4">
        <h2 class="font-bold text-gray-700 mb-3 flex items-center">
            ğŸ‘¥ å‚ä¸è€… 
            <span class="text-xs font-normal text-gray-400 ml-2">(æˆäºº=1ä»½, å„¿ç«¥=0.5ä»½)</span>
        </h2>
        <div id="personList" class="space-y-2 mb-3"></div>
        <div class="flex gap-2">
            <input id="newPersonName" type="text" placeholder="åå­—" class="flex-1 border border-gray-300 p-2 rounded-lg text-sm focus:outline-none focus:border-green-500">
            <select id="newPersonType" class="border border-gray-300 p-2 rounded-lg text-sm bg-white">
                <option value="1">æˆäºº</option>
                <option value="0.5">å„¿ç«¥</option>
            </select>
            <button onclick="addPerson()" class="btn-primary px-4 py-2 text-sm whitespace-nowrap">æ·»åŠ </button>
        </div>
    </div>

    <div class="card p-4 mb-4">
        <h2 class="font-bold text-gray-700 mb-3">ğŸ’° è®°ä¸€ç¬”</h2>
        <div class="flex flex-col gap-3">
            <div class="flex gap-2">
                <select id="payerSelect" class="flex-1 border border-gray-300 p-2 rounded-lg text-sm bg-white"></select>
                <input id="expenseAmount" type="number" placeholder="é‡‘é¢" class="w-24 border border-gray-300 p-2 rounded-lg text-sm focus:outline-none focus:border-green-500">
            </div>
            <div class="flex gap-2">
                <input id="expenseDesc" type="text" placeholder="å¤‡æ³¨ (å¦‚: åˆé¥­)" class="flex-1 border border-gray-300 p-2 rounded-lg text-sm">
                <button onclick="addExpense()" class="btn-primary px-6 py-2">è®°è´¦</button>
            </div>
        </div>
        
        <div class="mt-4 border-t pt-4">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">è´¦å•æ˜ç»†</h3>
            <div id="expenseList" class="space-y-2 max-h-60 overflow-y-auto text-sm">
                <div class="text-center text-gray-400 py-4">æš‚æ— è´¦å•</div>
            </div>
        </div>
    </div>

    <button onclick="calculate()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg mb-4 active:scale-95 transition-transform">
        âœ¨ æŸ¥çœ‹åˆ†æ‘Šç»“æœ
    </button>

    <div id="resultModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">ç»“ç®—æ–¹æ¡ˆ</h2>
                <button onclick="closeModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            
            <div id="summaryArea" class="bg-indigo-50 p-4 rounded-xl mb-4 text-sm space-y-1"></div>
            
            <h3 class="font-bold text-indigo-700 mb-2 text-sm">ğŸ‘‰ è½¬è´¦æ–¹æ¡ˆ (æœ€ä¼˜è§£)</h3>
            <div id="transferList" class="space-y-3"></div>

            <button onclick="closeModal()" class="w-full mt-6 border border-gray-300 py-2 rounded-lg text-gray-600">å…³é—­</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG: è¯·åœ¨è¿™é‡Œæ›¿æ¢ä½ çš„ Firebase é…ç½®
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyBWglZNeHVI_iVHg1AvlEiXx7q_KsVjM98",
  authDomain: "skinotes.firebaseapp.com",
  projectId: "skinotes",
  storageBucket: "skinotes.firebasestorage.app",
  messagingSenderId: "566725772222",
  appId: "1:566725772222:web:2e9b46b0f000b8a78bafef",
  measurementId: "G-QQR42WN92C"
};
        // ==========================================

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // è·å–æˆ¿é—´å· (URL å‚æ•° ?room=xyz)
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');

        // å¦‚æœæ²¡æœ‰æˆ¿é—´å·ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå¹¶è·³è½¬
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8);
            window.location.search = `?room=${roomId}`;
        }
        document.getElementById('roomIdDisplay').innerText = roomId;

        let currentData = { people: [], expenses: [] };
        let docRef = db.collection('trips').doc(roomId);

        // --- å®æ—¶ç›‘å¬æ•°æ® ---
        docRef.onSnapshot((doc) => {
            if (doc.exists) {
                currentData = doc.data();
                renderUI();
            } else {
                // åˆå§‹åŒ–æ–°æˆ¿é—´
                currentData = { people: [], expenses: [] };
                docRef.set(currentData);
            }
        });

        // --- æ“ä½œå‡½æ•° ---

        function addPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            const type = parseFloat(document.getElementById('newPersonType').value);
            
            if (!name) return alert('è¯·è¾“å…¥åå­—');
            if (currentData.people.some(p => p.name === name)) return alert('åå­—é‡å¤äº†');

            const newPerson = {
                id: Date.now().toString(),
                name: name,
                weight: type
            };

            // æ›´æ–°äº‘ç«¯
            docRef.update({
                people: firebase.firestore.FieldValue.arrayUnion(newPerson)
            });

            document.getElementById('newPersonName').value = '';
        }

        function removePerson(id) {
            if(!confirm('ç¡®å®šåˆ é™¤æ­¤äººå—ï¼Ÿç›¸å…³çš„è´¦å•å¯èƒ½ä¼šå‡ºé”™ã€‚')) return;
            const personToRemove = currentData.people.find(p => p.id === id);
            docRef.update({
                people: firebase.firestore.FieldValue.arrayRemove(personToRemove)
            });
        }

        function addExpense() {
            const payerId = document.getElementById('payerSelect').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const desc = document.getElementById('expenseDesc').value.trim() || 'æ‚è´¹';

            if (!payerId) return alert('è¯·é€‰æ‹©è°ä»˜çš„é’±');
            if (isNaN(amount) || amount <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');

            const newExpense = {
                id: Date.now().toString(),
                payerId: payerId,
                amount: amount,
                desc: desc,
                time: new Date().toLocaleString()
            };

            docRef.update({
                expenses: firebase.firestore.FieldValue.arrayUnion(newExpense)
            });

            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDesc').value = '';
        }

        function deleteExpense(expenseId) {
            const expense = currentData.expenses.find(e => e.id === expenseId);
            if(confirm(`ç¡®å®šåˆ é™¤"${expense.desc}"è¿™ç¬”è´¦å—ï¼Ÿ`)) {
                docRef.update({
                    expenses: firebase.firestore.FieldValue.arrayRemove(expense)
                });
            }
        }

        // --- æ¸²æŸ“ UI ---
        function renderUI() {
            // æ¸²æŸ“äººå‘˜åˆ—è¡¨
            const pList = document.getElementById('personList');
            pList.innerHTML = currentData.people.map(p => `
                <div class="flex justify-between items-center bg-white border border-gray-100 p-2 rounded">
                    <div>
                        <span class="font-medium">${p.name}</span>
                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded ml-1">${p.weight === 1 ? 'æˆäºº' : 'å„¿ç«¥'}</span>
                    </div>
                    <button onclick="removePerson('${p.id}')" class="text-red-300 hover:text-red-500 text-xs">åˆ é™¤</button>
                </div>
            `).join('');

            // æ¸²æŸ“ä»˜æ¬¾äººä¸‹æ‹‰æ¡†
            const selector = document.getElementById('payerSelect');
            const currentVal = selector.value;
            selector.innerHTML = `<option value="">-- è°ä»˜çš„é’± --</option>` + 
                currentData.people.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            selector.value = currentVal; // ä¿æŒé€‰ä¸­çŠ¶æ€

            // æ¸²æŸ“è´¦å•åˆ—è¡¨ (å€’åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢)
            const eList = document.getElementById('expenseList');
            if (currentData.expenses.length === 0) {
                eList.innerHTML = '<div class="text-center text-gray-400 py-4">æš‚æ— è´¦å•ï¼Œå¿«å»è®°ä¸€ç¬”å§</div>';
            } else {
                eList.innerHTML = [...currentData.expenses].reverse().map(e => {
                    const payer = currentData.people.find(p => p.id === e.payerId);
                    return `
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded border-l-4 border-green-400">
                            <div>
                                <div class="text-gray-800 font-medium">Â¥${e.amount} <span class="text-gray-500 font-normal text-xs">- ${e.desc}</span></div>
                                <div class="text-xs text-gray-400">${payer ? payer.name : 'æœªçŸ¥äººå‘˜'} å«ä»˜</div>
                            </div>
                            <button onclick="deleteExpense('${e.id}')" class="text-gray-400 hover:text-red-500 text-xs px-2">Ã—</button>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- æ ¸å¿ƒç®—æ³• ---
        function calculate() {
            if (currentData.people.length === 0) return alert('è¯·å…ˆæ·»åŠ å‚ä¸è€…');

            const people = currentData.people;
            const expenses = currentData.expenses;
            
            // 1. è®¡ç®—æ€»æƒé‡å’Œæ€»èŠ±è´¹
            const totalWeight = people.reduce((sum, p) => sum + p.weight, 0);
            const totalExpense = expenses.reduce((sum, e) => sum + e.amount, 0);
            
            if (totalWeight === 0) return alert('æ€»æƒé‡ä¸º0ï¼Œæ— æ³•è®¡ç®—');
            
            const unitPrice = totalExpense / totalWeight; // å•ä»½ä»·æ ¼

            // 2. è®¡ç®—æ¯ä¸ªäººï¼šå·²ä»˜ã€åº”ä»˜ã€å·®é¢
            let balances = people.map(p => {
                const paid = expenses
                    .filter(e => e.payerId === p.id)
                    .reduce((sum, e) => sum + e.amount, 0);
                const shouldPay = unitPrice * p.weight;
                const balance = paid - shouldPay; // æ­£æ•°=å¤šä»˜äº†(åˆ«äººè¯¥ç»™æˆ‘)ï¼Œè´Ÿæ•°=å°‘ä»˜äº†(è¯¥ç»™åˆ«äºº)
                return { name: p.name, balance, paid, shouldPay, weight: p.weight };
            });

            // æ¸²æŸ“æ±‡æ€»
            document.getElementById('summaryArea').innerHTML = `
                <div class="flex justify-between font-bold border-b border-indigo-100 pb-2">
                    <span>æ€»å¼€é”€</span>
                    <span>Â¥${totalExpense.toFixed(2)}</span>
                </div>
                ${balances.map(b => `
                    <div class="flex justify-between text-gray-600 mt-1">
                        <span>${b.name} <span class="text-xs text-gray-400">(${b.weight===1?'æˆ':'ç«¥'})</span></span>
                        <span>
                            <span class="text-xs mr-2">å«ä»˜ Â¥${b.paid.toFixed(0)}</span>
                            <span class="${b.balance >= 0 ? 'text-green-600' : 'text-red-500'} font-bold">
                                ${b.balance >= 0 ? 'æ”¶' : 'ä»˜'} Â¥${Math.abs(b.balance).toFixed(2)}
                            </span>
                        </span>
                    </div>
                `).join('')}
            `;

            // 3. è®¡ç®—æœ€ä¼˜è½¬è´¦ (è´ªå¿ƒç®—æ³•)
            let debtors = balances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance); // æ¬ é’±æœ€å¤šçš„æ’å‰é¢
            let creditors = balances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance); // è¢«æ¬ æœ€å¤šçš„æ’å‰é¢

            let transfers = [];
            let i = 0, j = 0;
            
            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                
                // äº¤æ˜“é¢æ˜¯ä¸¤è€…ç»å¯¹å€¼çš„è¾ƒå°è€…
                let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                
                transfers.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });

                // æ›´æ–°ä½™é¢
                debtor.balance += amount;
                creditor.balance -= amount;

                // è°å¹³è´¦äº†ï¼Œè°å°±å‡ºå±€
                if (Math.abs(debtor.balance) < 0.01) i++;
                if (creditor.balance < 0.01) j++;
            }

            // æ¸²æŸ“è½¬è´¦åˆ—è¡¨
            const tList = document.getElementById('transferList');
            if (transfers.length === 0) {
                tList.innerHTML = '<div class="text-center text-green-600 bg-green-50 p-3 rounded">ğŸ‰ è´¦ç›®å·²å¹³ï¼Œæ— éœ€è½¬è´¦ï¼</div>';
            } else {
                tList.innerHTML = transfers.map(t => `
                    <div class="flex justify-between items-center bg-white border border-gray-200 p-3 rounded-lg shadow-sm">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700">${t.from}</span>
                            <span class="text-gray-400">â”</span>
                            <span class="font-bold text-gray-700">${t.to}</span>
                        </div>
                        <div class="font-mono text-lg font-bold text-indigo-600">Â¥${t.amount.toFixed(2)}</div>
                    </div>
                `).join('');
            }

            document.getElementById('resultModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶ï¼å‘ç»™ç¾¤é‡Œçš„æœ‹å‹å³å¯ä¸€èµ·è®°è´¦');
            });
        }
    </script>
</body>
</html>
